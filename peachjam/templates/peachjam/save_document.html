{% load i18n %}
{% if request.user.is_authenticated %}
  <div id="saveDocumentWrapper">
    <button id="saveDocumentButton"
            class="btn btn-outline-primary btn-shrink-sm ms-2"
            type="button"
            data-bs-toggle="modal"
            data-bs-target="#saveDocumentModal"
            aria-expanded="false"
            {% if not saved_document %} hx-post="{% url 'saved_document_create' %}" hx-target="#saveDocumentWrapper" hx-include="#save-document-form" {% endif %}>
      {% if saved_document %}
        <i class="bi bi-star-fill"></i>
        {% if saved_document.folder %}
          {% trans 'Saved to' %} {{ saved_document.folder }}
        {% else %}
          {% trans 'Saved' %}
        {% endif %}
      {% else %}
        {% trans 'Save document' %}
      {% endif %}
    </button>
    <div hx-swap-oob="true" id="saveDocumentModalDialog" class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <p class="h5 modal-title">{% trans 'Document saved' %}</p>
          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="save-document-form"
                {% if saved_document %} hx-post="{% url 'saved_document_update' saved_document.id %}" {% else %} hx-post="{% url 'saved_document_create' %}" {% endif %}
                hx-target="#saveDocumentWrapper">
            {% csrf_token %}
            {{ form.document }}
            <p class="h5">{{ saved_document.document }}</p>
            <label class="form-label" for="{{ form.folder.id_for_label }}">{{ form.folder.label }}</label>
            <select id="{{ form.folder.id_for_label }}"
                    class="form-select"
                    name="{{ form.folder.name }}">
              {% for value, name in form.fields.folder.choices %}
                <option value="{{ value }}"
                        {% if form.folder.value == value %} selected{% endif %}>
                  {{ name }}
                </option>
              {% endfor %}
            </select>
            <button type="button"
                    class="btn btn-link link-underline link-underline-opacity-0 ps-0"
                    data-bs-toggle="collapse"
                    data-bs-target="#addFolder"
                    aria-expanded="false"
                    aria-controls="addFolder">
              {% trans 'New folder...' %}
            </button>
            <div class="collapse" id="addFolder">
              <label class="form-label" for="{{ form.new_folder.id_for_label }}">{% trans 'New folder name' %}</label>
              <input class="form-control"
                     id="{{ form.new_folder.id_for_label }}"
                     name="{{ form.new_folder.name }}"
                     type="text"/>
            </div>
            <p class="mt-3">
              <a class="icon-link icon-link-hover link-underline link-underline-opacity-0"
                 href="{% url 'folder_list' %}">{% trans 'View saved documents' %}</a>
            </p>
          </form>
        </div>
        <div class="modal-footer d-flex justify-content-between">
          {% if saved_document %}
            <button class="btn btn-danger"
                    type="button"
                    data-bs-dismiss="modal"
                    hx-target="#saveDocumentWrapper"
                    hx-include="#save-document-form"
                    hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
                    hx-post="{% url 'saved_document_delete' saved_document.id %}"
                    hx-confirm="Are you sure you want to unsave this document?">
              {% trans 'Unsave' %}
            </button>
          {% endif %}
          <div>
            <button type="button"
                    class="btn btn-outline-secondary btn-shrink-sm ms-2"
                    data-bs-dismiss="modal">
              {% trans 'Close' %}
            </button>
            <button class="btn btn-primary ms-1"
                    type="submit"
                    form="save-document-form"
                    data-bs-dismiss="modal">
              {% trans 'Save' %}
            </button>
          </div>
        </div>
      </div>
    </div>
  {% else %}
    <button class="btn btn-outline-primary ms-2"
            id="saveDocumentButton"
            data-bs-toggle="modal"
            type="button"
            aria-expanded="false"
            hx-swap-oob="true"
            data-bs-target="#saveDocumentModal">
      {% trans 'Save document' %}
    </button>
    <div hx-swap-oob="true" id="saveDocumentModalDialog" class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">{% trans 'Login' %}</h5>
          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>
            <strong>{% trans 'You are not logged in' %}.</strong>
          </p>
          <p>{% trans 'To save a document you need to be logged in' %}.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">{% trans 'Close' %}</button>
          <a href="{% url 'account_login' %}?next={{ document.get_absolute_url }}"
             class="btn btn-primary">{% trans 'Login' %}</a>
        </div>
      </div>
    </div>
  {% endif %}
</div>
